#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push checks..."
echo "   (These are more thorough than pre-commit)"
echo ""

# Get the current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üìç Current branch: $BRANCH"

# Block pushing to protected branches - must use feature branches
PROTECTED_BRANCHES="main master production develop"
for protected in $PROTECTED_BRANCHES; do
  if [ "$BRANCH" = "$protected" ]; then
    echo ""
    echo "üö´ BLOCKED: Direct push to '$BRANCH' is not allowed!"
    echo ""
    echo "   You must use a feature branch and create a pull request."
    echo ""
    echo "   Steps to fix:"
    echo "   1. Create a new branch:  git checkout -b feature/your-feature-name"
    echo "   2. Commit your changes:  git add . && git commit -m 'your message'"
    echo "   3. Push the branch:      git push -u origin feature/your-feature-name"
    echo "   4. Create a PR on GitHub/GitLab"
    echo ""
    exit 1
  fi
done

# Full TypeScript check
echo ""
echo "üî∑ Running full TypeScript check..."
npx tsc --noEmit || {
  echo "‚ùå TypeScript check failed. Please fix type errors before pushing."
  exit 1
}

# Run all unit tests
echo ""
echo "üß™ Running all unit tests..."
npm run test:unit || {
  echo "‚ùå Unit tests failed. Please fix failing tests before pushing."
  exit 1
}

# Build check (ensures the project can build)
echo ""
echo "üèóÔ∏è  Verifying build..."
npm run build > /dev/null 2>&1 || {
  echo "‚ùå Build failed. Please fix build errors before pushing."
  exit 1
}
echo "   ‚úì Build successful"

# Security audit (non-blocking warning)
echo ""
echo "üîí Running security audit..."
npm audit --audit-level=high 2>/dev/null || {
  echo "‚ö†Ô∏è  Security vulnerabilities detected. Consider running 'npm audit fix'"
}

# Check for dependency updates (informational)
echo ""
echo "üì¶ Checking for outdated dependencies..."
OUTDATED=$(npm outdated --depth=0 2>/dev/null | tail -n +2 | wc -l)
if [ "$OUTDATED" -gt 0 ]; then
  echo "   ‚ö†Ô∏è  $OUTDATED package(s) have updates available"
fi

echo ""
echo "‚úÖ Pre-push checks passed! Your code is ready to push."
